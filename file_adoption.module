<?php
declare(strict_types=1);

/**
 * @file
 * Hooks and core integration for the file_adoption module.
 */

/**
 * Implements hook_cron().
 */
function file_adoption_cron(): void {
  $config = \Drupal::config('file_adoption.settings');
  $state = \Drupal::state();
  $frequency = $config->get('cron_frequency') ?: 'yearly';
  $intervals = [
    'every' => 0,
    'hourly' => 3600,
    'daily' => 86400,
    'weekly' => 604800,
    'monthly' => 2592000,
    'yearly' => 31536000,
  ];
  $last = (int) $state->get('file_adoption.last_cron', 0);
  $now = time();
  $interval = $intervals[$frequency] ?? 31536000;
  if ($last && ($now - $last) < $interval) {
    return;
  }
  $state->set('file_adoption.last_cron', $now);
  /** @var \Drupal\file_adoption\FileScanner $scanner */
  $scanner = \Drupal::service('file_adoption.file_scanner');
  $limit = (int) $config->get('items_per_run');

  if ($config->get('enable_adoption')) {
    $scanner->scanAndProcess(TRUE, $limit);
  }
  else {
    $scanner->recordOrphans($limit);
  }
}
