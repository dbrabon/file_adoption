<?php
declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;
use Drupal\file_adoption\FileScanner;

/** @return \Drupal\file_adoption\FileScanner */
function _file_adoption_scanner(): FileScanner {
  return \Drupal::service('file_adoption.scanner');
}

/**
 * Implements hook_cron().
 */
function file_adoption_cron(): void {
  $scanner = _file_adoption_scanner();
  $config  = \Drupal::config('file_adoption.settings');
  $state   = \Drupal::state();

  $now   = \Drupal::time()->getCurrentTime();
  $last  = (int) $state->get('file_adoption.last_cron', 0);
  $freq  = $config->get('cron_frequency') ?? 'daily';

  $map = [
    'hourly'  => 3600,
    'daily'   => 86400,
    'weekly'  => 604800,
    'monthly' => 2592000,
    'yearly'  => 31536000,
  ];
  $run = ($freq === 'every') || ($now - $last >= ($map[$freq] ?? 0));

  if ($run) {
    $scanner->scanPublicFiles();
    if ($config->get('enable_adoption')) {
      $scanner->adoptUnmanaged((int) ($config->get('items_per_run') ?? 20));
    }
    $state->set('file_adoption.last_cron', $now);
  }
}

/**
 * Implements hook_entity_insert().
 */
function file_adoption_entity_insert(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'file') {
    return;
  }
  $uri = $entity->getFileUri();
  if (!str_starts_with($uri, 'public://')) {
    return;
  }
  $scanner  = _file_adoption_scanner();
  $relative = substr($uri, 9);
  $ignored  = $scanner->isIgnored($relative, $scanner->getIgnorePatterns());

  \Drupal::database()->merge('file_adoption_index')
    ->key('uri', $uri)
    ->fields([
      'timestamp'       => \Drupal::time()->getCurrentTime(),
      'is_ignored'      => $ignored ? 1 : 0,
      'is_managed'      => 1,
      'directory_depth' => substr_count($relative, '/'),
    ])
    ->execute();
}

/**
 * Implements hook_entity_delete().
 */
function file_adoption_entity_delete(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'file') {
    return;
  }
  $uri = $entity->getFileUri();
  if (!str_starts_with($uri, 'public://')) {
    return;
  }
  $scanner  = _file_adoption_scanner();
  $relative = substr($uri, 9);
  $ignored  = $scanner->isIgnored($relative, $scanner->getIgnorePatterns());
  $real     = \Drupal::service('file_system')->realpath($uri);

  if ($real && file_exists($real)) {
    \Drupal::database()->merge('file_adoption_index')
      ->key('uri', $uri)
      ->fields([
        'timestamp'       => \Drupal::time()->getCurrentTime(),
        'is_ignored'      => $ignored ? 1 : 0,
        'is_managed'      => 0,
        'directory_depth' => substr_count($relative, '/'),
      ])
      ->execute();
  }
  else {
    \Drupal::database()->delete('file_adoption_index')
      ->condition('uri', $uri)
      ->execute();
  }
}
