<?php
declare(strict_types=1);

use Drupal\Core\Database\Connection;
use Drupal\file_adoption\FileScanner;

/**
 * @return \Drupal\file_adoption\FileScanner
 */
function _file_adoption_scanner(): FileScanner {
  return \Drupal::service('file_adoption.scanner');
}

/**
 * Implements hook_cron().
 *
 * 1.  Ensure the index table is populated (initial full scan happens
 *     the first time cron runs after installation).
 * 2.  Adopt (or delete) up to the configured number of files where
 *     is_managed = 0 AND is_ignored = 0.
 */
function file_adoption_cron(): void {
  $scanner = _file_adoption_scanner();

  // Step 1 – scan & (re‑)index anything missing.
  $scanner->scanPublicFiles();

  // Step 2 – adopt the next batch.
  $config       = \Drupal::config('file_adoption.settings');
  $items_per_run = (int) $config->get('items_per_run') ?? 20;
  $scanner->adoptUnmanaged($items_per_run);
}
