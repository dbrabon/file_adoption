<?php

/**
 * @file
 * Hooks and core integration for the file_adoption module.
 */

/**
 * Implements hook_cron().
 */
function file_adoption_cron() {
  $config = \Drupal::config('file_adoption.settings');
  if (!$config->get('enable_adoption')) {
    return;
  }

  /** @var \Drupal\file_adoption\FileScanner $scanner */
  $scanner = \Drupal::service('file_adoption.file_scanner');

  $limit = (int) $config->get('items_per_run');
  if ($limit <= 0) {
    $limit = 20;
  }

  try {
    $query = \Drupal::database()->select('file_adoption_file', 'f')
      ->fields('f', ['uri'])
      ->condition('f.ignore', 0)
      ->condition('f.managed', 0)
      ->orderBy('f.id')
      ->range(0, $limit);
    $result = $query->execute();
    foreach ($result as $row) {
      $scanner->adoptFile($row->uri);
    }
  }
  catch (\Throwable $e) {
    $scanner->scanAndProcess(TRUE, $limit);
  }
}
